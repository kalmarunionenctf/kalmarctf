from Crypto.Cipher import AES
from Crypto.Hash import SHA256
from Crypto.Util.Padding import pad, unpad

def restrict(I, omega):
    B = I.quaternion_algebra()
    M_I = basis_matrix(I)
    frac_O = (QQ^4).span([ai.coefficient_tuple() for ai in(B(1), omega)], ZZ)
    M = I.free_module().intersection(frac_O).basis_matrix()
    return [sum(c*g for c,g in zip(ai, B.basis())) for ai in M]

def basis_matrix(O):
    M_O = Matrix(QQ, [ai.coefficient_tuple() for ai in O.gens()])
    return M_O

def connectingIdeal(O1, O2):
    I = O1*O2
    I *= I.norm().denominator()
    return I

def gram_matrix(basis):
    M = []
    for a in basis:
        M.append([a.pair(b) for b in basis])
    return Matrix(QQ, M)

def ReducedBasis(I):
    B = I.basis()
    G = gram_matrix(I.basis())
    U = G.LLL_gram().transpose()
    return [sum(c*beta for c, beta in zip(row, B)) for row in U]

def invariant(O):
    return [b.reduced_norm() for b in ReducedBasis(O)]

def reduceHeight(O):
    B = O.quaternion_algebra()
    O0 = B.maximal_order()
    I_conn = connectingIdeal(O0, O)
    alpha = ReducedBasis(I_conn)[0]
    O_reduced = B.quaternion_order([alpha * b * alpha^(-1) for b in O.basis()])
    return O_reduced, alpha 

def findIsom(O1, omega1, omega2):
    #alpha*omega1 - omega2*alpha = 0
    B = O1.quaternion_algebra()
    i,j,k = B.gens()
    a1, b1, c1, d1 = omega1.coefficient_tuple()
    a2, b2, c2, d2 = omega2.coefficient_tuple()
    System = [[a1-a2, i**2*(b1-b2), j**2*(c1 - c2), k**2*(d1 - d2)],
              [(b1*i - i*b2)/i, (i*a1 - a2*i)/i, (j*k*d1 - k*d2*j)/i, (k*c1*j - c2*j*k)/i],
              [(c1*j - c2*j)/j, (i*d1*k - d2*k*i)/j, (c1*j - c2*j)/j, (k*b1*i - b2*i*k)/j],
              [(d1*k - d2*k)/k, (i*c1*j - c2*j*i)/k, (j*b1*i - b2*i*j)/k, (k*a1 - a2*k)/k]]
    alpha = list(Matrix(QQ, System).right_kernel().basis_matrix())[0]
    assert alpha != 0
    return sum(c*g for c,g in zip(alpha, B.basis()))

def decrypt_flag(shared_secret, ct, iv):
    key = SHA256.new(data=str(shared_secret).encode()).digest()[:128]
    cipher = AES.new(key, AES.MODE_CBC, bytes.fromhex(iv))
    pt = cipher.decrypt(bytes.fromhex(ct))
    return pt

p = next_prime(2**512)
B = QuaternionAlgebra(-1, -p)
i, j, k = B.gens()
O0 = B.maximal_order()

omega = 820*i + 362*j + 153*k

OA = B.quaternion_order((1/2 + 3139087966091527042724164371063030589339051004055967708170664892869345562111556348824225107517132393372689924522050655616406567328491765185222261961510689237267929279311609782357418840040524294659354641284484877569218388068290341759283720114793779176925526516557587289975027/10442377652832819173998733806230064520891239136345405981379819800234023363303*i + 134778440535064812863375326525680671757807663794802391672110044840763350292072954729998392344884999643549527453283432206206949877310069115342752466352262534906781232133028642392278182688574560907221/20884755305665638347997467612460129041782478272690811962759639600468046726606*j - 43091275557021159604726731850608138198864140730540333090865526303329247724069191896511275626434057338605046889855045314660749263796751941097612066423909406864013310272043155527235913423939886019838/10442377652832819173998733806230064520891239136345405981379819800234023363303*k, 1140050166384153598671053808284547083333475644918422714446369512375893132485731139381530742536969409980435300717930924487567999227211511890397400723353143612297986098621785381389526850709006473292510965784349596898721479168956408005354508087542657553124660679404528523394147/3632131357507067538782168280427848529005648395250575993523415582690095082888*i + 12237167707370108196751855640002138498871359778128385127343971890461132197963103634019583957229998371722761561279272832477175682729513124379137038511476773531976941499104527212077756891084578017347/1816065678753533769391084140213924264502824197625287996761707791345047541444*j - 15649837277307762048338384942381246456385650075794688800899813920966038887781526712987224027319619859505190442931210706648568209228305734906665114474845447426114000822316475055400707969769593552017/3632131357507067538782168280427848529005648395250575993523415582690095082888*k, 4429241630244300276185066527786269913437212951473229965283260188911425788848363746608152806469622279830925514744525062967808923806989910906708639109699465335604608711279984014352843493086295205003127663987102826790806271328621278051347060882884165397960688865140107314012565/20884755305665638347997467612460129041782478272690811962759639600468046726606*i + 47542971567359151521911567391320879216509420622472348763552232897282905068932744281590121946749907962261424394491984810076246355954014985885567031308645049327304980016730439679916878763205201495642/10442377652832819173998733806230064520891239136345405981379819800234023363303*j - 60801632085235350761850170487824977559767741405105260423755930057717334344947943793514775185333603661958839251880139112452159061760671463844149573783156854146273914037751930858094632342788046428243/20884755305665638347997467612460129041782478272690811962759639600468046726606*k, 8127110234121807894711590956465852443918991064750640867399399382565956459597861648688747623598907293659834183343677559497817345506977149834180408736343291613467108405966455115076831867075801973634290901150836683486067280944540088985787819576290951309741417201090241845887543/20884755305665638347997467612460129041782478272690811962759639600468046726606*i + 87235468967705661341463759134359792541298243172330042908557811943480445223140210448408270398135091681288103058791447396130703521356054129457185435043617485579476252116298202712361303925369359411579/10442377652832819173998733806230064520891239136345405981379819800234023363303*j - 111563470142849287657056756914607575235688821517056071939706175155599656551328823792530327320402625692461348307540042146190837993426336300546298691912480773309779327050420691250849021352971497651109/20884755305665638347997467612460129041782478272690811962759639600468046726606*k))
omega_a = 1488266680223628278052716774800848920150209606085755664927315320253115807338197965423709338743416996320477970870328474909133893923744995072998902636306976821/41769510611331276695994935224920258083564956545381623925519279200936093453212*i + 4304923789650889416341506002435686012474185301440806830974435812227155920104535/20884755305665638347997467612460129041782478272690811962759639600468046726606*j - 5490522672141162020425974965469057837877682094875572736667326524671446445343519/41769510611331276695994935224920258083564956545381623925519279200936093453212*k
assert omega_a in OA

OB = B.quaternion_order((1/2 + 67603061877917546581014053870390865710887564229110733994469491179315205060761671275827761352541668356174918753277633081472855068939196239932598231859386010427583586314042165892363277979259312170043906630947975397848782463492363528871450903101980275840472273538544057925931898258254643488057466715/86345955631696964923541238482995069495782689860786497820890631303408038460012*i + 78108336144202612466091400357069784896451217830178095446188226510449722273978273674278009476782488056075516173227821938863643593266295390940531629582288493305734364132512097277710442607545490297105000512170039594526554/21586488907924241230885309620748767373945672465196624455222657825852009615003*j - 66905759350991844902321136865518433457650545896893272702800893288709796728427509362317749556511471303552122843869387104460145888516701963830934407092048766247276973780182856240888903402665801738104745503340318332157117/86345955631696964923541238482995069495782689860786497820890631303408038460012*k, 4410302443251615519210239021163431823116457787529955638138268629062174712378551374309502139942545978452431215828329731431756344904853012099490247076131499692958646227888110867462337215051136888626907805158931530461852624818322459069890746944115585819042516915340164986170599385831583932629583217/86345955631696964923541238482995069495782689860786497820890631303408038460012*i + 10191295369348341727584902236168528687730570836315071446902948419454513174838504249625764457112529978205019931090138641790786881115905068456199722388057672133565571349000846262421190959331339573345190703051431672203353/43172977815848482461770619241497534747891344930393248910445315651704019230006*j - 4364811677704049466708913884020679099194206819323779687031139822320861885754650927140411419277284234046412998034659437990899772502620945899215842063169150342033734372534727875801915122948289213291636201142451164751915/86345955631696964923541238482995069495782689860786497820890631303408038460012*k, 54812828347362120518560458065125277829171077491111696912323415310884086836839025045598416293116555117145163566485298627120210926623649343069008997458193673445811815533220629459890800865238157890283369207130419811183539662657376517874541032067593452530959132504830546363485602867518576127143853993/86345955631696964923541238482995069495782689860786497820890631303408038460012*i + 126661092046445668462777938031231154903568751816213825049937665945044530221819331007572044381831785396436826698411441179495474678531451075386331548188373616492500876685541689969155447416440431234658877268301497946596545/43172977815848482461770619241497534747891344930393248910445315651704019230006*j - 54247452717134265109719798738666557618776151254840681295567002074748637743117033030493845938010312191103657576251827571919950853444832193507359835940641444607751614023758151915480482324468387255015869930080294326651243/86345955631696964923541238482995069495782689860786497820890631303408038460012*k, 80393295408472972643467649675656453592604050967109771076615567047746323284684317506057106411966781595204673940069967535825499211254743136796187466260578347409355357094863702324835755093280466449804444054765530984514025264327350539868360774136367099149985414572257569488378193648990710848971079437/86345955631696964923541238482995069495782689860786497820890631303408038460012*i + 185772252530364781401587663397047984682236119504498556734815240096754358874093763689539993525298166827865237994499846575959099694533730488375794970140780356730436579844506699141686323013741529953761124780378660431509671/43172977815848482461770619241497534747891344930393248910445315651704019230006*j - 79564065984849424694922474992370309296524940538945864110034784502670955713737985694141653175012630416000588111486946637000340923588571734154508978243456087886802333536607560566297324480863216221193621076600342337662991/86345955631696964923541238482995069495782689860786497820890631303408038460012*k))
omega_b = 93854655509598179697018174987440922892355560744146753644064930106052348210517552056213812068369758755966994390266423194656501984614900232612296873486328037/3320998293526806343213124557038271903683949610030249916188101203977232248462*i - 213212194562831097262821364056368569450983235386163293389577796669216369074556/1660499146763403171606562278519135951841974805015124958094050601988616124231*j - 929863630181202852454041634559154377456610883066951505016079437005438635782643/3320998293526806343213124557038271903683949610030249916188101203977232248462*k
assert omega_b in OB

#Orientations must "agree", i.e. be induced by the same K \hookrightarrow B orientation
gamma_a = findIsom(OA, omega_a, omega)
gamma_b = findIsom(OB, omega_b, omega)

OA = B.quaternion_order([gamma_a * b * gamma_a^(-1) for b in OA.basis()])
OB = B.quaternion_order([gamma_b * b * gamma_b^(-1) for b in OB.basis()])

assert omega in OA
assert omega in OB

#The connecting ideal is already generated by a quadratic ideal
a = restrict(connectingIdeal(O0, OA), omega)
O_shared = (OB*a[0] + OB*a[1]).right_order()

iv = '363ed27310ef8c97c77badc698586b18'
ct = '833ae0fb36d8e98ae3b287f2adf745e20b9ad0f215bf1b47f1e5cd6b91b6a707d15e9ed227c597bbc80cdc8cf41c275f'
print(decrypt_flag(invariant(O_shared), ct, iv))